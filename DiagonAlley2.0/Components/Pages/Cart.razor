@page "/cart"

@using DiagonAlley2._0.Components.Pages.Particles
@using DiagonAlley2._0.Components.Shop
@using DiagonAlley2._0.Services.Helper
@using global::Services

@inject CartService CartSvc
@inject NavigationManager Nav

<div class="particles-container">
    <ParticlesHome />
</div>
<Toast @ref="ToastRef" />

<div class="cart-container">
    <h1 class="magic-title">Your Cart</h1>

    <div class="shop-btn">
        <button class="btn" @onclick="GoBack">Back</button>
    </div>

    @if (CartSvc.Wizard == null)
    {
        <p class="cart-message">You must be logged in.</p>
    }
    else if (CartSvc.Wizard.Cart.Count == 0)
    {
        <p class="cart-message">Your cart is empty.</p>
    }
    else
    {
            <div class="cart-list">
                    <div class="flex">
                                <div class="cart-items">
                                    @foreach (var item in CartSvc.Wizard.Cart)
                                    {
                                        @if (item.Product != null)
                                        {<div class="cart-item">
                        <img src="@ProductImageHelper.GetImage(item.Product.Type)"
                             alt="@item.Product.Name"
                             class="cart-image" />

                        <div class="cart-info">
                            <h3 class="cart-product-name">@item.Product.Name</h3>

                            <div class="quantity-controls">
                                <button class="cart-button"
                                        @onclick="() => CartSvc.Decrease(item)">➖</button>

                                <span class="quantity-label">@item.Quantity</span>

                                <button class="cart-button"
                                        @onclick="() => CartSvc.Increase(item)">➕</button>
                            </div>

                            <p class="price">
                                💰 @item.TotalPrice galleons
                            </p>
                        </div>
                     

                        <button class="delete-btn"
                                @onclick="() => CartSvc.Remove(item)">
                            🗑️
                        </button>
                    </div>
                    }
                }
            </div>
            <div class="checkout">
                <p class="cart-total">Subtotal: @CartSvc.Subtotal </p>
                <p class="cart-total">Discount: @CartSvc.DiscountAmount </p>
                <p class="cart-total">Total: @CartSvc.Total galleons</p>

                <button class="btn checkout-btn"
                        @onclick="Checkout">
                    Checkout
                </button>
            </div>

        </div>
   </div>
    }
</div>

@code {
    private Toast? ToastRef;
    protected override async Task OnInitializedAsync()
    {
        await CartSvc.LoadCartAsync();
    }

    void GoBack() => Nav.NavigateTo("/shop");

    async Task Checkout()
    {
        
        await CartSvc.Clear();
        await ToastRef!.Show("Order placed! Your items will arrive by owl 🦉");
        Nav.NavigateTo("/shop");
    }
}
