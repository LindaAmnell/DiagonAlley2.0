@using DiagonAlley2._0.Services
@using global::Models.Enum
@using DiagonAlley2._0.Models
@inject ProductService ProductService

<div class="admin-form">

    <h2 class="magic-subtitle">
        @(IsEdit ? "Edit Product" : "Add Product")
    </h2>

    <div class="form-group">
        <label class="labels">Name</label>
        <input class="input" @bind="Name" />
    </div>

    <div class="form-group">
        <label class="labels">Price</label>
        <input class="input"
               type="number"
               step="0.01"
               @bind="Price" />
    </div>

    <div class="form-group">
        <label class="labels">Product Type</label>
        <select class="input"
                @bind="Type"
                disabled="@IsEdit">
            @foreach (var productType in Enum.GetValues<ProductType>())
            {
                <option value="@productType">@productType</option>
            }
        </select>
    </div>

    <div class="divider"></div>

    <ProductTypeFields
        Type="Type"

        Core="Core"
        Length="Length"
        OnCoreChanged="v => Core = v"
        OnLengthChanged="v => Length = v"

        Effect="Effect"
        Duration="Duration"
        OnEffectChanged="v => Effect = v"
        OnDurationChanged="v => Duration = v"

        Speed="Speed"
        Manufacturer="Manufacturer"
        OnSpeedChanged="v => Speed = v"
        OnManufacturerChanged="v => Manufacturer = v" />

        <div class="btn-div">

    <button class="btn admin-submit" @onclick="Save">
        @(IsEdit ? "Product" : "Save Product")
    </button>
    <button class="btn" @onclick="Cancel">Cancel</button>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <p class="error">@ErrorMessage</p>
    }


        </div>

</div>

@code {
    [Parameter] public Product? Model { get; set; }
    [Parameter] public bool IsEdit { get; set; }

    [Parameter] public EventCallback OnSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private string Name { get; set; } = "";
    private decimal Price { get; set; }
    private ProductType Type { get; set; }

    private string? Core;
    private int Length;

    private string? Effect;
    private int Duration;

    private int Speed;
    private string? Manufacturer;

    private string? ErrorMessage;

    protected override void OnParametersSet()
    {
        if (!IsEdit || Model is null)
            return;

        Name = Model.Name;
        Price = Model.Price;
        Type = Model.Type;

        Core = Model.Core;
        Length = Model.Length ?? 0;

        Effect = Model.Effect;
        Duration = Model.Duration ?? 0;

        Speed = Model.Speed ?? 0;
        Manufacturer = Model.Manufacturer;
    }

    async Task Save()
    {
        try
        {
            ErrorMessage = null;

            var product = BuildProduct();

            if (IsEdit)
            {
                product.Id = Model!.Id;
                await ProductService.UpdateAsync(product);
            }
            else
            {
                await ProductService.CreateAsync(product);
            }

            await OnSaved.InvokeAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
    }

    async Task Cancel()
        => await OnCancel.InvokeAsync();

    private Product BuildProduct()
    {
        return new Product
        {
            Name = Name,
            Price = Price,
            Type = Type,

            Core = Type == ProductType.Wand ? Core : null,
            Length = Type == ProductType.Wand ? Length : null,

            Effect = Type == ProductType.Potion ? Effect : null,
            Duration = Type == ProductType.Potion ? Duration : null,

            Speed = Type == ProductType.Broomstick ? Speed : null,
            Manufacturer = Type == ProductType.Broomstick ? Manufacturer : null
        };
    }
}
